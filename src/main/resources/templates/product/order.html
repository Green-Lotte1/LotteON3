<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org"
       xmlns:layout="http://www.thymeleaf.org"
       layout:decorate="/product/_prod_layout">

<!-- 주문 페이지 시작-->
<section class="order" layout:fragment="content">

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:src="@{/js/prodJs/prodZipcode.js}"></script>
    <script>
        /*휴대폰 번호 자동 하이픈*/
        const hypenTel = (target) => {
            target.value = target.value
                .replace(/[^0-9]/g, '')
                .replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g, "$1-$2-$3").replace(/(\-{1,2})$/g, "");
        }

        //max point 넘겨서 사용 하려 할 시 변환
        const point = parseInt('[[${#authentication.principal.user.point}]]');
        const maxPoint = (target) => {
            usePoint = parseInt(target.value)
            if (point <= usePoint) {
                target.value = point
            }
        }
        window.onload = () => {
            //토탈 값 쉼표 제거
            total = $('input[name=ordTotPrice]').val()
            total = total.replace(",", "");
            total = parseInt(total);




            const discountPoint = document.getElementsByClassName('discountPoint')[0]
            const discountPointBut = document.getElementsByClassName('discountPointBut')[0]
            let usePoint = 0;
            const newTotal = document.getElementsByClassName('total')[0]
            discountPointBut.addEventListener('click', (e) => {
                usePoint = parseInt($('input[name=usedPoint]').val());
                //포인트 체크
                if (usePoint < 5000) {
                    alert('최소 5,000원 이상의 금액을 입력해주세요.')
                } else if(total-usePoint < 0){
                    alert('전체 주문금액 보다 큰 금액 사용은 불가능합니다.')
                }else{
                    discountPoint.innerText = '-' + usePoint.toLocaleString()
                    console.log(total - usePoint)
                    newTotal.innerText = (total - usePoint).toLocaleString()
                    $('input[name=ordTotPrice]').val(total - usePoint);
                }
            })


            // 폼 데이터 검증결과 상태변수
            let isRecipNameOk = true;
            let isRecipHpOk = true;
            let isRecipAddrOk = true;
            let isOrdPaymentOk = false;

            // 데이터 검증에 사용하는 정규표현식
            let reName = /^[가-힣]{2,10}$/
            let reHp = /^01(?:0|1|[6-9])-(?:\d{4})-\d{4}$/;

            // 유효성 검증(Validation)

            // 이름 검사
            $('input[name=recipName]').focusout(function () {
                const name = $(this).val();

                if (name.match(reName)) {
                    isRecipNameOk = true;
                } else {
                    isRecipNameOk = false;
                }
            });

            // 번호 검사
            $('input[name=recipHp]').keyup(function () {
                const hp = $(this).val();
                if (hp.match(reHp)) {
                    isRecipHpOk = true;
                } else {
                    isRecipHpOk = false;
                }
            });
            // 주소 검사
            const addr = document.getElementsByName('recipAddr2');
            addr[0].focusout = function () {
                const addr = document.getElementsByName('recipAddr1');
                if (addr[0].value == '') {
                    isRecipAddrOk = false;
                } else {
                    isRecipAddrOk = true;
                }
            }
            // 결제수단 검사
            $('input[name=ordPayment]').click(function () {
                isOrdPaymentOk = true;
            });


            const payment = document.getElementsByName('payment')[0]
            payment.addEventListener('click', (e) => {

                if (!isRecipNameOk) {
                    alert('수령인을 확인 하십시오.');
                    return false; // 폼 전송 취소
                }


                if (!isRecipHpOk) {
                    alert('전화번호를 확인 하십시오.');
                    return false; // 폼 전송 취소
                }
                if (!isRecipAddrOk) {
                    alert('주소를 확인 하십시오.');
                    return false; // 폼 전송 취소
                }

                if (!isOrdPaymentOk) {
                    alert('결제수단을 확인 하십시오.');
                    return false; // 폼 전송 취소
                }



                if (!confirm('결제하시겠습니까?')) {
                    e.preventDefault();
                } else {
                    document.getElementById('orderForm').submit();
                }
            })


        }

    </script>
    <!-- 제목, 페이지 네비게이션 -->
    <nav>
        <h1>주문결제</h1>
        <p>
            HOME > 장바구니 > <strong>주문결제</strong>
        </p>
    </nav>

    <form id="orderForm" action="#">
        <!-- 주문 상품 목록 -->
        <table class="formOrder">
            <thead>
            <tr>
                <th>상품명</th>
                <th>총수량</th>
                <th>판매가</th>
                <th>포인트</th>
                <th>배송비</th>
                <th>소계</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${dtoList.size() eq 0}" class="cartEmpty">
                <td colspan="8">장바구니에 상품이 없습니다.</td>
            </tr>
            <tr th:each="cart:${dtoList}" th:class="${cart.cartNo}">
                <input type="hidden" th:name="cartNo" th:value="${cart.cartNo }"/>
                <td>
                    <article>
                        <a th:href="@{/product/view(prodNo=${cart.prodNo}, cate1=${cart.product.prodCate1}, cate2=${cart.product.prodCate2})}" class="thumb">
                            <img th:src="@{'/thumbs/' + ${cart.product.thumb1}}" alt="상품이미지"/>
                        </a>
                        <div>
                            <h2>
                                <a th:href="@{/product/view(prodNo=${cart.prodNo}, cate1=${cart.product.prodCate1}, cate2=${cart.product.prodCate2})}">
                                    [[${cart.product.prodName}]]
                                </a>
                            </h2>
                            <p class="">[[${cart.product.descript}]]</p>
                        </div>
                    </article>
                </td>
                <td th:text="${cart.count}"></td>
                <td>
                    <span class="finalPrice">
                        [[${#numbers.formatInteger((cart.product.price - cart.product.discountPrice),0,'COMMA')}]]
                    </span>
                    <span class="origPrice">
                        ( [[${#numbers.formatInteger(cart.product.price,0,'COMMA')}]] )
                    </span>
                </td>
                <td th:text="${cart.product.point}"></td>
                <td>
                    <span th:if="${cart.product.delivery eq 0}">
                      무료배송
                    </span>
                    <span th:if="${cart.product.delivery gt 0}">
                      [[${cart.product.deliverySub}]]원
                    </span>
                </td>
                <td>
                    [[${#numbers.formatInteger((cart.product.price - cart.product.discountPrice)*cart.count +cart.product.delivery,0,'COMMA')}]]
                    <span>
                        / [[${#numbers.formatInteger((cart.product.point * cart.count),0,'COMMA')}]] p
                    </span>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- 최종 결제 정보 -->
        <div class="final">
            <h2>최종결제 정보</h2>
            <table border="0">
                <tr>
                    <td>총</td>
                    <td>[[${dtoList.size()}]] 건 ([[${orderTotal.totalCount}]] 개)</td>
                </tr>
                <tr>
                    <td>상품금액</td>
                    <td>[[${#numbers.formatInteger(orderTotal.totalPrice,0,'COMMA')}]]</td>

                </tr>
                <tr>
                    <td>할인금액</td>
                    <td>[[${#numbers.formatInteger(orderTotal.totalDiscount,0,'COMMA')}]]</td>
                </tr>
                <tr>
                    <td>배송비</td>
                    <td>[[${#numbers.formatInteger(orderTotal.totalDelivery,0,'COMMA')}]]</td>
                </tr>
                <tr>
                    <td>포인트 할인</td>
                    <td class="discountPoint">-</td>
                </tr>
                <tr>
                    <td>포인트 적립</td>
                    <td>[[${#numbers.formatInteger(orderTotal.totalPoint,0,'COMMA')}]]</td>
                </tr>
                <tr>
                    <td>전체주문금액</td>
                    <td>
                        [[${#numbers.formatInteger(orderTotal.totalSumPrice,0,'COMMA')}]]
                    </td>
                </tr>
            </table>
            <input type="text" name="ordTotPrice" th:value="${orderTotal.totalSumPrice}">
            <input type="button" value="결제하기">
        </div>

        <!-- 배송정보 -->
        <article class="delivery">
            <h1>배송정보</h1>
            <table>
                <tr>
                    <td>수령인</td>
                    <td><input type="text" name="recipName"  th:value="${#authentication.principal.user.name}"/></td>
                </tr>
                <tr>
                    <td>휴대폰</td>
                    <td>
                        <input type="text" name="recipHp"  oninput="hypenTel(this)" th:value="${#authentication.principal.user.hp}"
                               minlength="13" maxlength="13"/>
                        <span>- 포함 입력</span>
                    </td>
                </tr>
                <tr>
                    <td>우편번호</td>
                    <td>
                        <input type="text" name="recipZip"   th:value="${#authentication.principal.user.zip}"/>
                        <input type="button" value="검색"  onclick="zipcode()"/>
                    </td>
                </tr>
                <tr>
                    <td>기본주소</td>
                    <td>
                        <input type="text" name="recipAddr1"  th:value="${#authentication.principal.user.addr1}"/>
                    </td>
                </tr>
                <tr>
                    <td>상세주소</td>
                    <td>
                        <input type="text" name="recipAddr2"  th:value="${#authentication.principal.user.addr2}"/>
                    </td>
                </tr>
            </table>
        </article>

        <!-- 할인정보 -->
        <article class="discount">
            <h1>할인정보</h1>

            <div>
                <p>현재 포인트 : <span>[[${#authentication.principal.user.point}]]</span>점</p>
                <label>
                    <input type="number" name="usedPoint" onkeyup="maxPoint(this)"
                           th:maxlength="${#authentication.principal.user.point}"/>점
                    <input type="button" value="적용" class="discountPointBut"/>
                </label>
                <span>포인트 5,000점 이상이면 현금처럼 사용 가능합니다.</span>
            </div>
        </article>

        <!-- 결제방법 -->
        <article class="payment">
            <h1>결제방법</h1>
            <div>
                <span>신용카드</span>
                <p>
                    <label><input type="radio" name="payment" value="type1"/>신용카드 결제</label>
                    <label><input type="radio" name="payment" value="type2"/>체크카드 결제</label>
                </p>
            </div>
            <div>
                <span>계좌이체</span>
                <p>
                    <label><input type="radio" name="payment" value="type3"/>실시간 계좌이체</label>
                    <label><input type="radio" name="payment" value="type4"/>무통장 입금</label>
                </p>
            </div>
            <div>
                <span>기타</span>
                <p>
                    <label><input type="radio" name="payment" value="type3"/>휴대폰결제</label>
                    <label>
                        <input type="radio" name="payment" value="type4"/>카카오페이
                        <img th:src="@{/images/ico_kakaopay.gif}" alt="카카오페이"/>
                    </label>
                </p>
            </div>
        </article>

        <!-- 경고 -->
        <article class="alert">
            <ul>
                <li><span>롯데ON의 모든 판매자는 안전거래를 위해 구매금액, 결제수단에 상관없이 모든거래에 대하여 롯데ON 유한책임회사의 구매안전서비스(에스크로)를 제공하고 있습니다.</span></li>
                <li><span>롯데ON 유한책임회사의 전자금융거래법에 의해 결제대금예치업 등록번호는 02-006-00008 입니다.</span></li>
                <li><span>등록여부는 금융감독원 홈페이지(www.fss.or.kr)의 업무자료>인허가업무안내>전자금융업등록현황에서 확인하실수 있습니다.</span></li>
            </ul>
        </article>

    </form>

</section>
<!-- 주문 페이지 끝-->

</html>